<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Vertical Garden</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />

    <style>
      /* IMPROVED FAIL-SAFE CSS */
      body { max-width: 960px; margin: auto; padding: 15px; font-family: system-ui, -apple-system, sans-serif; }
      
      /* Use Flexbox for responsiveness */
      .status { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; justify-content: space-around; }
      .status article { 
        flex: 1; min-width: 140px; text-align: center; 
        padding: 15px; border-radius: 12px;
        background: rgba(128, 128, 128, 0.05); /* Very subtle gray that works in both modes */
        border: 1px solid rgba(128, 128, 128, 0.2);
      }

      /* Dynamic Range Group - Uses Pico's Primary color if available, else blue */
      .range-group { 
        margin-bottom: 1.5rem; 
        border-left: 5px solid var(--pico-primary, #1095c1); 
        padding: 1rem; 
        background: rgba(128, 128, 128, 0.03); 
        border-radius: 0 10px 10px 0; 
      }
      
      /* Theme-aware Highlights */
      mark { 
        background-color: var(--pico-mark-background-color, rgba(255, 215, 0, 0.3)); 
        color: var(--pico-mark-color, inherit);
        padding: 0.2rem 0.5rem; border-radius: 5px; 
      }

      /* Clean Details (No Border) */
      details { border: none !important; margin-bottom: 2rem; }
      summary { font-size: 1.2rem; font-weight: bold; list-style: none; cursor: pointer; padding: 10px 0; border-bottom: 1px solid rgba(128, 128, 128, 0.2); }
      summary::-webkit-details-marker { display: none; }

      /* Responsive Grid Fallback */
      .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1auto)); gap: 1rem; }
      
      input[type="range"] { width: 100%; cursor: pointer; }
      output { font-weight: bold; font-family: monospace; }
      small { display: block; margin-bottom: 5px; opacity: 0.8; }
    </style>
  </head>
  <body>
    <nav>
      <ul><li><strong>üå± Vertical Garden</strong></li></ul>
      <ul>
        <li id="clock">--:--</li>
        <li>
          <select onchange="setTheme(this.value)">
            <option value="auto">Auto</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </li>
        <li><button class="secondary" onclick="openMaintenance()">Maintenance</button></li>
      </ul>
    </nav>
    <main>
      <details open>
        <summary>üè¢ Floor 3 ‚Äì Grow Bed</summary>
        <article class="preset">
          <div class="status">
            <article><strong>Moisture</strong><p><mark id="m3Val">85%</mark></p></article>
            <article><strong>Light</strong><p><mark id="l3Val">60%</mark></p></article>
            <article><strong>Pump</strong><p><mark id="p3State">AUTO</mark></p></article>
          </div>
          <div class="range-group">
            <label><strong>üíß Water ON (Min %)</strong>
              <input type="range" min="0" max="100" value="90" disabled /><output></output>
            </label>
            <label><strong>üõë Water OFF (Max %)</strong>
              <input type="range" min="0" max="100" value="30" disabled /><output></output>
            </label>
          </div>
          <div class="grid-2">
            <label>Brightness <input type="range" min="0" max="100" value="60" disabled /><output></output></label>
            <label>Light ON <input type="time" value="08:30" disabled /></label>
            <label>Light OFF <input type="time" value="17:30" disabled /></label>
          </div>
          <button type="button" onclick="togglePresetEdit(this)">Edit Preset</button>
        </article>
      </details>

      <details open>
        <summary>üè¢ Floor 2 ‚Äì Grow Bed</summary>
        <article class="preset">
          <div class="status">
            <article><strong>Moisture</strong><p><mark id="m2Val">40%</mark></p></article>
            <article><strong>Light</strong><p><mark id="l2Val">80%</mark></p></article>
            <article><strong>Pump</strong><p><mark id="p2State">AUTO</mark></p></article>
          </div>
          <div class="range-group">
            <label><strong>üíß Water ON (Min %)</strong>
              <input type="range" min="0" max="100" value="30" disabled /><output></output>
            </label>
            <label><strong>üõë Water OFF (Max %)</strong>
              <input type="range" min="0" max="100" value="80" disabled /><output></output>
            </label>
          </div>
          <div class="grid-2">
            <label>Brightness <input type="range" min="0" max="100" value="80" disabled /><output></output></label>
            <label>Light ON <input type="time" value="8:30" disabled /></label>
            <label>Light OFF <input type="time" value="17:30" disabled /></label>
          </div>
          <button type="button" onclick="togglePresetEdit(this)">Edit Preset</button>
        </article>
      </details>
      
      <details>
        <summary>üíß Floor 1 ‚Äì Reservoir</summary>
        <article>
          <label>Reservoir Light Brightness (%)
            <input type="range" id="f1MainSlider" min="0" max="100" value="0" onchange="saveF1(this.value)" />
            <output>{{floor1Brightness}}</output>
          </label>
        </article>
      </details>
    </main>

    <dialog id="maintenance">
      <article>
        <header><strong>üõ† Maintenance Mode</strong></header>
        <div class="grid">
          <div><h5>F1</h5><label>LED <input type="range" min="0" max="255" value="0" oninput="setManual('light1', this.value)" /></label></div>
          <div><h5>F2</h5><label>LED <input type="range" min="0" max="255" value="0" oninput="setManual('light2', this.value)" /></label><label>Pump <input type="range" min="0" max="255" value="0" oninput="setManual('pump2', this.value)" /></label></div>
          <div><h5>F3</h5><label>LED <input type="range" min="0" max="255" value="0" oninput="setManual('light3', this.value)" /></label><label>Pump <input type="range" min="0" max="255" value="0" oninput="setManual('pump3', this.value)" /></label></div>
        </div>
        <hr />
        <button class="contrast" onclick="resetWifi()">Reset WiFi Credentials</button>
        <button class="secondary" onclick="closeMaintenance()">Close</button>
      </article>
    </dialog>

    <script>
      // --- CONSOLE LOGGER ---
      const log = (msg, type="info") => {
        const time = new Date().toLocaleTimeString();
        const styles = {
            info: "color: #1095c1",
            success: "color: #4caf50; font-weight: bold",
            warn: "color: #ff9800",
            error: "color: #f44336; font-weight: bold"
        };
        console.log(`%c[${time}] ${msg}`, styles[type]);
      };

      document.addEventListener("DOMContentLoaded", () => {
        log("Dashboard Initialized", "success");

        // Sync Sliders
        document.querySelectorAll('input[type="range"]').forEach((slider) => {
          const out = slider.nextElementSibling;
          if (out && out.tagName === "OUTPUT") out.value = slider.value;
          slider.addEventListener("input", () => { if(out) out.value = slider.value });
        });

        // Clock & Time Sync
        setInterval(() => { document.getElementById("clock").textContent = new Date().toLocaleTimeString(); }, 1000);
        const epoch = Math.floor(new Date().getTime() / 1000); 
        fetch(`/syncTime?epoch=${epoch}&tz=${new Date().getTimezoneOffset() * -1}`)
             .then(() => log("Time Synced with Browser", "success"));

        // REAL-TIME STATUS
        function fetchStatus() {
          if(document.getElementById("maintenance").open) return;
          fetch('/status')
            .then(r => r.json())
            .then(data => {
              document.getElementById("m2Val").textContent = data.m2 + "%";
              document.getElementById("l2Val").textContent = data.l2 + "%";
              document.getElementById("p2State").textContent = (data.p2 == 1) ? "WATERING" : "Idle";
              document.getElementById("m3Val").textContent = data.m3 + "%";
              document.getElementById("l3Val").textContent = data.l3 + "%";
              document.getElementById("p3State").textContent = (data.p3 == 1) ? "WATERING" : "Idle";
            }).catch(e => log("Status Fetch Failed: " + e, "error"));
        }
        setInterval(fetchStatus, 3000);

        window.openMaintenance = () => {
            log("Entering Maintenance Mode", "warn");
            fetch('/toggleMaintenance?state=1');
            document.getElementById("maintenance").showModal();
        };
        window.closeMaintenance = () => {
            log("Resuming Automation", "success");
            fetch('/toggleMaintenance?state=0');
            document.getElementById("maintenance").close();
        };
        window.setManual = (dev, val) => {
            log(`Manual Control: ${dev} -> ${val}`);
            fetch(`/manualControl?dev=${dev}&val=${val}`);
        }
        window.saveF1 = (v) => {
            log(`F1 Brightness Saved: ${v}%`);
            fetch(`/saveF1?val=${v}`);
        }
        
        window.resetWifi = () => {
            if(confirm("Reset WiFi and Restart?")) {
                log("WiFi Reset Triggered", "error");
                window.location.href = "/resetWifi"; 
            }
        };

        window.togglePresetEdit = function (button) {
           const presetBox = button.closest(".preset");
           const floorName = button.closest("details").querySelector("summary").textContent.trim();
           const inputs = presetBox.querySelectorAll("input");
           const isEditing = button.dataset.editing === "true";
           inputs.forEach(i => i.disabled = isEditing);

           if (isEditing) {
             const [min, max, brit, onT, offT] = Array.from(inputs).map(i => i.value);
             log(`Saving Preset for ${floorName}: Min ${min}%, Max ${max}%`, "success");
             const params = new URLSearchParams({ floor: floorName, min, max, brightness: brit, onTime: onT, offTime: offT });
             fetch('/savePreset?' + params.toString());
             button.textContent = "Edit Preset";
           } else {
             button.textContent = "Save Preset";
           }
           button.dataset.editing = (!isEditing).toString();
        };

        window.setTheme = (mode) => {
          log(`Theme changed to: ${mode}`);
          if (mode === "auto") document.documentElement.removeAttribute("data-theme");
          else document.documentElement.setAttribute("data-theme", mode);
        };
      });
    </script>
  </body>
</html>